rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. SERVICES: Public Read, Partner Write
    match /services/{serviceId} {
      allow read: if true;
      allow write: if request.auth != null && isPartner(request.auth.uid);
    }
    
    // 2. PARTNERS: Admin only
    match /partners/{partnerId} {
      allow read: if request.auth != null && request.auth.uid == partnerId;
      allow write: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // 3. ANALYTICS: Anonymous Create, Partner Read
    match /analytics_gaps/{docId} {
      allow create: if true;
      allow read: if request.auth != null && isPartner(request.auth.uid);
      allow update, delete: if false;
    }

    // 4. [NEW] PUBLIC REPORTS: Anonymous Create (Secure)
    match /reports/{docId} {
      allow create: if true;
      allow read, update, delete: if false; // Only admins can process reports
    }

    // 5. [NEW] PARTNER REQUESTS: Anonymous Create (Secure)
    match /partner_requests/{docId} {
      allow create: if true;
      allow read, update, delete: if false; // Only admins can process requests
    }
    
    // --- Helper Functions ---
    function isPartner(uid) {
      return exists(/databases/$(database)/documents/partners/$(uid)) || isWhitelisted();
    }
    
    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/admins/$(uid));
    }
    
    function isWhitelisted() {
      return request.auth.token.email in [
        'test@test.org', 
        'hc.tsai@sustainsage-group.com'
      ] || 
      request.auth.token.email.matches('.*@sustainsage-group\\.com') ||
      request.auth.token.email.matches('.*@portsmouthbridge\\.org');
    }
  }
}