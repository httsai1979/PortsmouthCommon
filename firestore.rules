rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. Public Read: Anyone can view service details
    match /services/{serviceId} {
      allow read: if true;
      // Partner Write: Only authenticated partners can modify
      allow write: if request.auth != null && isPartner(request.auth.uid);
    }
    
    // 2. Partner Registry
    match /partners/{partnerId} {
      allow read: if request.auth != null && request.auth.uid == partnerId;
      allow write: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // 3. Search Analytics Logs
    match /analytics_gaps/{docId} {
      allow create: if true;
      allow read: if request.auth != null && isPartner(request.auth.uid);
      allow update, delete: if false;
    }
    
    // --- Permission Helpers ---
    
    // Check if user is a verified partner (including test accounts)
    function isPartner(uid) {
      return exists(/databases/$(database)/documents/partners/$(uid)) ||
             isWhitelisted();
    }
    
    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/admins/$(uid));
    }
    
    // Developer Whitelist
    function isWhitelisted() {
      return request.auth.token.email in [
        'test@test.org', 
        'hc.tsai@sustainsage-group.com'
      ] || 
      request.auth.token.email.matches('.*@sustainsage-group\\.com') ||
      request.auth.token.email.matches('.*@portsmouthbridge\\.org');
    }
  }
}