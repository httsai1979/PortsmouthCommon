rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. 公開讀取：任何人都可以看服務內容
    match /services/{serviceId} {
      allow read: if true;
      // 只有合作夥伴可以修改
      allow write: if request.auth != null && isPartner(request.auth.uid);
    }
    
    // 2. 合作夥伴名單
    match /partners/{partnerId} {
      allow read: if request.auth != null && request.auth.uid == partnerId;
      allow write: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // 3. 搜尋分析紀錄
    match /analytics_gaps/{docId} {
      allow create: if true;
      allow read: if request.auth != null && isPartner(request.auth.uid);
      allow update, delete: if false;
    }
    
    // --- 權限判斷工具 ---
    
    // 判斷是否為合作夥伴 (包含你的測試帳號)
    function isPartner(uid) {
      return exists(/databases/$(database)/documents/partners/$(uid)) ||
             isWhitelisted();
    }
    
    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/admins/$(uid));
    }
    
    // 這裡是白名單，你的 Email 只要在這裡面就有權限
    function isWhitelisted() {
      return request.auth.token.email in [
        'test@test.org', 
        'hc.tsai@sustainsage-group.com'
      ] || 
      request.auth.token.email.matches('.*@sustainsage-group\\.com') ||
      request.auth.token.email.matches('.*@portsmouthbridge\\.org');
    }
  }
}